#!/bin/bash
#
# Short:    Do something when the active Console User changes
# Author:   Mark J Swift
# Version:  1.0.2
# Modified: 29-Apr-2017
#
# Called by ConsoleUserWarden as follows:    
#   ConsoleUserWarden-NewConsoleUser <ActiveConsoleUser>

# ---

# assume that all scripts are in a subdirectory off the main project directory
GLB_sv_ProjectDirPath="$(dirname $(dirname ${0}))"

# Include the CommonLib
. "${GLB_sv_ProjectDirPath}/inc/Common.sh"

# Exit if something went wrong unexpectedly
if test -z "${GLB_sv_ProjectName}"
then
  exit 90
fi

# ---

sv_ActiveConsoleUser="${1}"
sv_PreviousConsoleUser="${2}"

# ---

GLB_nf_logmessage ${GLB_iv_MsgLevelNotice} "New Console User - '${sv_ActiveConsoleUser}' (previously '${sv_PreviousConsoleUser}')"

case ${sv_ActiveConsoleUser} in
init|none)
  # Should never happen
  ;;

loginwindow)
  case ${sv_PreviousConsoleUser} in
  init|none|loginwindow)
    # Might never happen
    ;;

  *)
    # changes from user to loginwindow at fast user logout
    # changes from user to loginwindow when fast user switching to a new user login
    if test -z "$(who | grep "console" | cut -d" " -f1 | grep -E "^${sv_PreviousConsoleUser}$")"
    then
      GLB_nf_logmessage ${GLB_iv_MsgLevelInfo} "User ${sv_PreviousConsoleUser} logged out"
      say "User ${sv_PreviousConsoleUser} logged out"
    fi
    ;;

  esac
  ;;

*)
  case ${sv_PreviousConsoleUser} in
  init)
    # Might never happen
    ;;

  none|loginwindow)
    # Changes from none to user at login
    # Changes from loginwindow to user at fast user login, 
    # Changes from loginwindow to user at fast user switch after a fast user logout
    GLB_nf_logmessage ${GLB_iv_MsgLevelInfo} "User ${sv_ActiveConsoleUser} logged in"
    say "User ${sv_ActiveConsoleUser} logged in"
    ;;

  *)
    # Changes from user to user at fast user switch
    GLB_nf_logmessage ${GLB_iv_MsgLevelInfo} "Fast User Switch ${sv_ActiveConsoleUser}"
    say "Fast User Switch ${sv_ActiveConsoleUser}"
    ;;
  esac

  ;;

esac
